<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fitting Parameters for an Oscillatory System · Catalyst.jl</title><meta name="title" content="Fitting Parameters for an Oscillatory System · Catalyst.jl"/><meta property="og:title" content="Fitting Parameters for an Oscillatory System · Catalyst.jl"/><meta property="twitter:title" content="Fitting Parameters for an Oscillatory System · Catalyst.jl"/><meta name="description" content="Documentation for Catalyst.jl."/><meta property="og:description" content="Documentation for Catalyst.jl."/><meta property="twitter:description" content="Documentation for Catalyst.jl."/><meta property="og:url" content="https://docs.sciml.ai/Catalyst/stable/inverse_problems/examples/ode_fitting_oscillation/"/><meta property="twitter:url" content="https://docs.sciml.ai/Catalyst/stable/inverse_problems/examples/ode_fitting_oscillation/"/><link rel="canonical" href="https://docs.sciml.ai/Catalyst/stable/inverse_problems/examples/ode_fitting_oscillation/"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-90474609-3"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-90474609-3', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.png" alt="Catalyst.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Catalyst.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><span class="tocitem">Introduction to Catalyst</span><ul><li><a class="tocitem" href="../../../introduction_to_catalyst/catalyst_for_new_julia_users/">Introduction to Catalyst and Julia for New Julia users</a></li><li><a class="tocitem" href="../../../introduction_to_catalyst/introduction_to_catalyst/">Introduction to Catalyst</a></li></ul></li><li><span class="tocitem">Model Creation and Properties</span><ul><li><a class="tocitem" href="../../../model_creation/dsl_basics/">The Catalyst DSL - Introduction</a></li><li><a class="tocitem" href="../../../model_creation/dsl_advanced/">The Catalyst DSL - Advanced Features and Options</a></li><li><a class="tocitem" href="../../../model_creation/programmatic_CRN_construction/">Programmatic Construction of Symbolic Reaction Systems</a></li><li><a class="tocitem" href="../../../model_creation/compositional_modeling/">Compositional Modeling of Reaction Systems</a></li><li><a class="tocitem" href="../../../model_creation/constraint_equations/">Constraint Equations and Events</a></li><li><a class="tocitem" href="../../../model_creation/parametric_stoichiometry/">Symbolic Stochiometries</a></li><li><a class="tocitem" href="../../../model_creation/model_file_loading_and_export/">Loading Chemical Reaction Network Models from Files</a></li><li><a class="tocitem" href="../../../model_creation/model_visualisation/">Model Visualisation</a></li><li><a class="tocitem" href="../../../model_creation/network_analysis/">Network Analysis in Catalyst</a></li><li><a class="tocitem" href="../../../model_creation/chemistry_related_functionality/">Chemistry-related functionality</a></li><li><input class="collapse-toggle" id="menuitem-3-11" type="checkbox"/><label class="tocitem" for="menuitem-3-11"><span class="docs-label">Model creation examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../model_creation/examples/basic_CRN_library/">Library of Basic Chemical Reaction Network Models</a></li><li><a class="tocitem" href="../../../model_creation/examples/programmatic_generative_linear_pathway/">Programmatic, generative, modelling of a linear pathway</a></li><li><a class="tocitem" href="../../../model_creation/examples/hodgkin_huxley_equation/">Hodgkin-Huxley Equation</a></li><li><a class="tocitem" href="../../../model_creation/examples/smoluchowski_coagulation_equation/">Smoluchowski Coagulation Equation</a></li></ul></li></ul></li><li><span class="tocitem">Model simulation</span><ul><li><a class="tocitem" href="../../../model_simulation/simulation_introduction/">Model Simulation Introduction</a></li><li><a class="tocitem" href="../../../model_simulation/simulation_plotting/">Simulation plotting</a></li><li><a class="tocitem" href="../../../model_simulation/simulation_structure_interfacing/">Interfacing problems, integrators, and solutions</a></li><li><a class="tocitem" href="../../../model_simulation/ensemble_simulations/">Ensemble/Monte Carlo Simulations</a></li><li><a class="tocitem" href="../../../model_simulation/ode_simulation_performance/">Advice for performant ODE simulations</a></li><li><a class="tocitem" href="../../../model_simulation/sde_simulation_performance/">Advice for performant SDE simulations</a></li></ul></li><li><span class="tocitem">Steady state analysis</span><ul><li><a class="tocitem" href="../../../steady_state_functionality/homotopy_continuation/">Finding Steady States through Homotopy Continuation</a></li><li><a class="tocitem" href="../../../steady_state_functionality/nonlinear_solve/">Finding Steady States using NonlinearSolve.jl and SteadyStateDiffEq.jl</a></li><li><a class="tocitem" href="../../../steady_state_functionality/steady_state_stability_computation/">Steady state stability computation</a></li><li><a class="tocitem" href="../../../steady_state_functionality/bifurcation_diagrams/">Bifurcation Diagrams</a></li><li><a class="tocitem" href="../../../steady_state_functionality/dynamical_systems/">Analysing model steady state properties with DynamicalSystems.jl</a></li></ul></li><li><span class="tocitem">Inverse Problems</span><ul><li><a class="tocitem" href="../../optimization_ode_param_fitting/">Parameter Fitting for ODEs using Optimization.jl and DiffEqParamEstim.jl</a></li><li><a class="tocitem" href="../../behaviour_optimisation/">Optimization for non-data fitting purposes</a></li><li><a class="tocitem" href="../../structural_identifiability/">Structural Identifiability Analysis</a></li><li><a class="tocitem" href="../../global_sensitivity_analysis/">Global Sensitivity Analysis</a></li><li><input class="collapse-toggle" id="menuitem-6-5" type="checkbox" checked/><label class="tocitem" for="menuitem-6-5"><span class="docs-label">Inverse problem examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Fitting Parameters for an Oscillatory System</a><ul class="internal"><li><a class="tocitem" href="#Why-we-fit-the-parameters-in-iterations"><span>Why we fit the parameters in iterations</span></a></li></ul></li></ul></li></ul></li><li><a class="tocitem" href="../../../faqs/">FAQs</a></li><li><a class="tocitem" href="../../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Inverse Problems</a></li><li><a class="is-disabled">Inverse problem examples</a></li><li class="is-active"><a href>Fitting Parameters for an Oscillatory System</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Fitting Parameters for an Oscillatory System</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SciML/Catalyst.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SciML/Catalyst.jl/blob/master/docs/src/inverse_problems/examples/ode_fitting_oscillation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="parameter_estimation"><a class="docs-heading-anchor" href="#parameter_estimation">Fitting Parameters for an Oscillatory System</a><a id="parameter_estimation-1"></a><a class="docs-heading-anchor-permalink" href="#parameter_estimation" title="Permalink"></a></h1><p>In this example we will use <a href="https://github.com/SciML/Optimization.jl">Optimization.jl</a> to fit the parameters of an oscillatory system (the Brusselator) to data. Here, special consideration is taken to avoid reaching a local minimum. Instead of fitting the entire time series directly, we will start with fitting parameter values for the first period, and then use those as an initial guess for fitting the next (and then these to find the next one, and so on). Using this procedure is advantageous for oscillatory systems, and enables us to reach the global optimum.</p><p>First, we fetch the required packages.</p><pre><code class="language-julia hljs">using Catalyst
using OrdinaryDiffEq
using Optimization
using OptimizationOptimisers # Required for the ADAM optimizer.
using SciMLSensitivity # Required for `Optimization.AutoZygote()` automatic differentiation option.</code></pre><p>Next, we declare our model, the Brusselator oscillator.</p><pre><code class="language-julia hljs">brusselator = @reaction_network begin
    A, ∅ --&gt; X
    1, 2X + Y --&gt; 3X
    B, X --&gt; Y
    1, X --&gt; ∅
end
p_real = [:A =&gt; 1., :B =&gt; 2.]</code></pre><p>We simulate our model, and from the simulation generate sampled data points (to which we add noise). We will use this data to fit the parameters of our model.</p><pre><code class="language-julia hljs">u0 = [:X =&gt; 1.0, :Y =&gt; 1.0]
tspan = (0.0, 30.0)

sample_times = range(tspan[1]; stop = tspan[2], length = 100)
prob = ODEProblem(brusselator, u0, tspan, p_real)
sol_real = solve(prob, Rosenbrock23(); tstops = sample_times)
sample_vals = Array(sol_real(sample_times))
sample_vals .*= (1 .+ .1 * rand(Float64, size(sample_vals)) .- .05)</code></pre><p>We can plot the real solution, as well as the noisy samples.</p><pre><code class="language-julia hljs">using Plots
default(; lw = 3, framestyle = :box, size = (800, 400))

plot(sol_real; legend = nothing, color = [:darkblue :darkred])
scatter!(sample_times, sample_vals&#39;; color = [:blue :red], legend = nothing)</code></pre><img src="5f270929.svg" alt="Example block output"/><p>Next, we create a function to fit the parameters using the <code>ADAM</code> optimizer. For a given initial estimate of the parameter values, <code>pinit</code>, this function will fit parameter values, <code>p</code>, to our data samples. We use <code>tend</code> to indicate the time interval over which we fit the model.</p><pre><code class="language-julia hljs">function optimise_p(pinit, tend)
    function loss(p, _)
        newtimes = filter(&lt;=(tend), sample_times)
        newprob = remake(prob; tspan = (0.0, tend), p = p)
        sol = Array(solve(newprob, Rosenbrock23(); saveat = newtimes))
        loss = sum(abs2, sol .- sample_vals[:, 1:size(sol,2)])
        return loss, sol
    end

    # optimize for the parameters that minimize the loss
    optf = OptimizationFunction(loss, Optimization.AutoZygote())
    optprob = OptimizationProblem(optf, pinit)
    sol = solve(optprob, ADAM(0.1); maxiters = 100)

    # return the parameters we found
    return sol.u
end</code></pre><p>Next, we will fit a parameter set to the data on the interval <code>(0, 10)</code>.</p><pre><code class="language-julia hljs">p_estimate = optimise_p([5.0, 5.0], 10.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
 1.0358017829915893
 2.1394673535690383</code></pre><p>We can compare this to the real solution, as well as the sample data</p><pre><code class="language-julia hljs">newprob = remake(prob; tspan = (0., 10.), p = p_estimate)
sol_estimate = solve(newprob, Rosenbrock23())
plot(sol_real; color = [:blue :red], label = [&quot;X real&quot; &quot;Y real&quot;], linealpha = 0.2)
scatter!(sample_times, sample_vals&#39;; color = [:blue :red],
         label = [&quot;Samples of X&quot; &quot;Samples of Y&quot;], alpha = 0.4)
plot!(sol_estimate; color = [:darkblue :darkred], linestyle = :dash,
                    label = [&quot;X estimated&quot; &quot;Y estimated&quot;], xlimit = tspan)</code></pre><img src="abb69929.svg" alt="Example block output"/><p>Next, we use this parameter estimate as the input to the next iteration of our fitting process, this time on the interval <code>(0, 20)</code>.</p><pre><code class="language-julia hljs">p_estimate = optimise_p(p_estimate, 20.)
newprob = remake(prob; tspan = (0., 20.), p = p_estimate)
sol_estimate = solve(newprob, Rosenbrock23())
plot(sol_real; color = [:blue :red], label = [&quot;X real&quot; &quot;Y real&quot;], linealpha = 0.2)
scatter!(sample_times, sample_vals&#39;; color = [:blue :red],
         label = [&quot;Samples of X&quot; &quot;Samples of Y&quot;], alpha = 0.4)
plot!(sol_estimate; color = [:darkblue :darkred], linestyle = :dash,
                    label = [&quot;X estimated&quot; &quot;Y estimated&quot;], xlimit = tspan)</code></pre><img src="6afe23f7.svg" alt="Example block output"/><p>Finally, we use this estimate as the input to fit a parameter set on the full time interval of the sampled data.</p><pre><code class="language-julia hljs">p_estimate = optimise_p(p_estimate, 30.0)

newprob = remake(prob; tspan = (0., 30.0), p = p_estimate)
sol_estimate = solve(newprob, Rosenbrock23())
plot(sol_real; color = [:blue :red], label = [&quot;X real&quot; &quot;Y real&quot;], linealpha = 0.2)
scatter!(sample_times, sample_vals&#39;; color = [:blue :red],
         label = [&quot;Samples of X&quot; &quot;Samples of Y&quot;], alpha = 0.4)
plot!(sol_estimate; color = [:darkblue :darkred], linestyle = :dash,
                    label = [&quot;X estimated&quot; &quot;Y estimated&quot;], xlimit = tspan)</code></pre><img src="ed7136a5.svg" alt="Example block output"/><p>The final parameter estimate is then</p><pre><code class="language-julia hljs">p_estimate</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
 1.0009431885711588
 1.999963501627601</code></pre><p>which is close to the actual parameter set of <code>[1.0, 2.0]</code>.</p><h2 id="Why-we-fit-the-parameters-in-iterations"><a class="docs-heading-anchor" href="#Why-we-fit-the-parameters-in-iterations">Why we fit the parameters in iterations</a><a id="Why-we-fit-the-parameters-in-iterations-1"></a><a class="docs-heading-anchor-permalink" href="#Why-we-fit-the-parameters-in-iterations" title="Permalink"></a></h2><p>As previously mentioned, the reason we chose to fit the model on a smaller interval to begin with, and then extend the interval, is to avoid getting stuck in a local minimum. Here specifically, we chose our initial interval to be smaller than a full cycle of the oscillation. If we had chosen to fit a parameter set on the full interval immediately we would have obtained poor fit and an inaccurate estimate for the parameters.</p><pre><code class="language-julia hljs">p_estimate = optimise_p([5.0,5.0], 30.0)

newprob = remake(prob; tspan = (0.0,30.0), p = p_estimate)
sol_estimate = solve(newprob, Rosenbrock23())
plot(sol_real; color = [:blue :red], label = [&quot;X real&quot; &quot;Y real&quot;], linealpha = 0.2)
scatter!(sample_times,sample_vals&#39;; color = [:blue :red],
         label = [&quot;Samples of X&quot; &quot;Samples of Y&quot;], alpha = 0.4)
plot!(sol_estimate; color = [:darkblue :darkred], linestyle = :dash,
                    label = [&quot;X estimated&quot; &quot;Y estimated&quot;], xlimit = tspan)</code></pre><img src="8880ae55.svg" alt="Example block output"/></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../global_sensitivity_analysis/">« Global Sensitivity Analysis</a><a class="docs-footer-nextpage" href="../../../faqs/">FAQs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Friday 12 July 2024 02:12">Friday 12 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
